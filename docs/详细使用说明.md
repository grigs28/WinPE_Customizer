# WinPE Customizer 详细使用说明

## 目录

- [程序简介](#程序简介)
- [运行环境](#运行环境)
- [启动方式](#启动方式)
- [界面说明](#界面说明)
- [操作流程](#操作流程)
- [高级功能](#高级功能)
- [命令行模式](#命令行模式)

---

## 程序简介

WinPE Customizer 是一款专业的 Windows PE 定制工具，提供完整的图形界面和命令行支持，可以自动化完成 WinPE 的创建、定制和打包工作。

### 主要特点

- **双模式操作**: 支持图形界面和命令行两种方式
- **智能化流程**: 自动检测环境和依赖
- **模块化设计**: 可选择性启用/禁用功能
- **实时监控**: 详细的日志输出和进度显示
- **驱动集成**: 批量安装硬件驱动
- **中文化支持**: 完整的中文界面和字体

---

## 运行环境

### 必需组件

1. **Windows ADK (Assessment and Deployment Kit)**
   - 组件: 部署工具 + Windows PE 附加组件
   - 下载: https://learn.microsoft.com/zh-cn/windows-hardware/get-started/adk-install

2. **部署和映像工具环境**
   - 位置: 开始菜单 → Windows Kits → 部署和映像工具环境
   - **必须以管理员身份运行**

3. **Python 环境**
   - 版本: Python 3.8 或更高
   - 依赖包: colorama (自动安装)

4. **解压工具** (任选其一)
   - WinRAR 或 7-Zip

### 系统要求

- 操作系统: Windows 10/11 或 Windows Server 2016+
- 磁盘空间: 至少 10GB 可用空间
- 内存: 建议 4GB 以上
- 权限: 管理员权限

---

## 启动方式

### 方式 1: 图形界面（推荐新手）

```bash
# 步骤 1: 以管理员身份打开"部署和映像工具环境"
开始菜单 → Windows Kits → 部署和映像工具环境（右键 → 以管理员身份运行）

# 步骤 2: 切换到程序目录
cd D:\WinPE_work

# 步骤 3: 启动图形界面
python WinPE_Customizer_GUI.py

# 或使用完整 Python 路径
D:\APP\miniconda3\python.exe WinPE_Customizer_GUI.py
```

### 方式 2: 批处理文件

```bash
# 双击运行（自动检查管理员权限）
WinPE_Customizer.bat
```

### 方式 3: 命令行模式

```bash
# 完全自动化，适合脚本集成
python WinPE_Customizer.py [WinPE工作目录]

# 示例
python WinPE_Customizer.py D:\WinPE_amd64
```

---

## 界面说明

### 标签页 1: 主控制面板

#### 快速操作区

**映像管理**
- `📦 挂载 WIM`: 将 boot.wim 挂载到 mount 目录
- `💾 卸载并保存`: 保存所有更改并卸载
- `🗑 卸载不保存`: 丢弃更改并卸载

**系统管理**
- `🧹 清理临时文件`: 删除 mount 目录和临时文件
- `🔧 清理 WIM`: 运行 dism /cleanup-wim，修复挂载错误
- `📁 打开工作目录`: 快速打开 WinPE 工作目录

**主控制按钮**
- `▶ 一键执行全流程`: 自动完成所有启用的模块
- `⬛ 停止`: 停止当前任务（当前操作会完成）
- `🗑 清空日志`: 清空日志显示区域
- `💾 保存日志`: 将日志导出为文件

#### 运行日志

显示实时操作日志，颜色编码：
- 🟢 绿色: 成功消息
- 🔵 蓝色: 命令和信息
- 🟡 黄色: 警告
- 🔴 红色: 错误

#### 状态栏

- 显示当前状态（就绪/运行中/完成/失败）
- 进度条动画

### 标签页 2: 分步执行

提供 10 个独立步骤按钮，可以按需执行：

1. **步骤 0: 创建 WinPE 工作环境**
   - 使用 copype 创建基础目录结构

2. **步骤 1: 挂载 boot.wim**
   - 将 WIM 映像挂载到 mount 目录

3. **步骤 2: 安装功能包**
   - PowerShell、.NET Framework、WMI 等

4. **步骤 3: 安装中文语言包**
   - 为功能包添加中文界面

5. **步骤 4: 安装中文字体**
   - 中文字体支持和核心语言包

6. **步骤 5: 配置区域设置**
   - 语言、时区、输入法等

7. **步骤 6: 批量安装驱动**
   - 从 drive 目录递归安装驱动

8. **步骤 7: 复制外置程序**
   - 将第三方工具复制到 WinPE

9. **步骤 8: 创建自定义目录**
   - 创建 Tools、Temp 等工作目录

10. **步骤 9: 生成 ISO 文件**
    - 卸载 WIM 并生成可启动 ISO

### 标签页 3: 路径配置

配置各个目录路径：

- **WinPE 工作目录**: 存放 WinPE 文件的主目录
- **Windows ADK 路径**: ADK 组件目录（WinPE_OCs）
- **驱动程序目录**: 硬件驱动存放位置
- **外置程序目录**: 第三方工具存放位置
- **输出 ISO 文件名**: 生成的 ISO 文件名

### 标签页 4: 模块设置

选择要执行的模块：

- ✅ 启用的模块会在"一键执行"时自动运行
- ❌ 禁用的模块会被跳过

**快速选择按钮**:
- `全选`: 启用所有模块
- `全不选`: 禁用所有模块
- `推荐配置`: 启用常用模块（不包括外置程序和自定义目录）

### 标签页 5: 帮助

内置完整帮助文档，包括：
- 程序简介和功能说明
- 详细操作步骤
- 常见问题解答
- 快捷键列表
- 链接到外部文档

---

## 操作流程

### 新手推荐流程（一键模式）

1. **准备工作**
   ```
   - 安装 Windows ADK
   - 准备驱动文件（可选）
   - 准备外置程序（可选）
   ```

2. **配置路径**
   ```
   切换到"路径配置"标签页
   - 设置 WinPE 工作目录（如 D:\WinPE_amd64）
   - 确认 Windows ADK 路径正确
   - 设置驱动目录（如有）
   ```

3. **选择模块**
   ```
   切换到"模块设置"标签页
   - 点击"推荐配置"（或自定义选择）
   - 根据需求调整模块开关
   ```

4. **开始执行**
   ```
   回到"主控制面板"
   - 点击"▶ 一键执行全流程"
   - 等待自动完成（约 30-60 分钟）
   - 查看日志确认无错误
   ```

5. **测试验证**
   ```
   - 使用虚拟机测试生成的 ISO
   - 或制作 USB 启动盘测试
   ```

### 高级用户流程（分步模式）

1. **创建环境**
   ```
   分步执行 → 步骤 0: 创建 WinPE 工作环境
   ```

2. **挂载编辑**
   ```
   分步执行 → 步骤 1: 挂载 boot.wim
   ```

3. **手动操作**（可选）
   ```
   - 打开工作目录
   - 手动修改 mount 目录中的文件
   - 复制自定义文件
   ```

4. **安装组件**
   ```
   根据需求执行步骤 2-8
   - 可以跳过某些步骤
   - 可以重复执行某个步骤
   ```

5. **完成打包**
   ```
   分步执行 → 步骤 9: 生成 ISO 文件
   ```

---

## 高级功能

### 手动挂载和修改

1. **挂载 WIM**
   ```
   主控制面板 → 快速操作 → 📦 挂载 WIM
   ```

2. **手动修改文件**
   ```bash
   # 打开挂载目录
   主控制面板 → 📁 打开工作目录 → mount

   # 可以：
   - 添加/删除文件
   - 修改配置文件
   - 安装额外程序
   ```

3. **保存更改**
   ```
   主控制面板 → 快速操作 → 💾 卸载并保存
   ```

### 自定义启动脚本

在 `mount\Windows\System32` 创建 `startnet.cmd`:

```batch
@echo off
wpeinit
echo Welcome to Custom WinPE!

REM 启动网络
wpeinit

REM 映射网络驱动器
net use Z: \\server\share

REM 运行自定义程序
X:\Tools\MyTool.exe

cmd
```

### 集成自定义驱动

1. **准备驱动**
   ```
   将驱动文件夹放到 drive 目录
   drive/
   ├── RAID/
   ├── Storage/
   └── Network/
   ```

2. **启用驱动安装模块**
   ```
   模块设置 → ✅ 批量安装硬件驱动
   ```

3. **执行安装**
   ```
   一键执行全流程 或 分步执行 → 步骤 6
   ```

### 添加第三方工具

1. **放置工具**
   ```
   将工具放到 外置程序 目录
   外置程序/
   ├── DiskGenius.exe
   ├── Ghost/
   └── Tools/
   ```

2. **配置列表**
   ```python
   # 编辑 config.py
   EXTERNAL_APPS = [
       ("DiskGenius.exe", "Windows/System32", "磁盘工具"),
       ("Tools/MyTool.exe", "Tools", "自定义工具"),
   ]
   ```

3. **启用复制模块**
   ```
   模块设置 → ✅ 复制外置程序
   ```

### 批量生成多个版本

使用命令行模式批量处理：

```batch
@echo off
REM 生成基础版
python WinPE_Customizer.py D:\WinPE_Basic

REM 生成完整版
python WinPE_Customizer.py D:\WinPE_Full

REM 生成服务器版
python WinPE_Customizer.py D:\WinPE_Server
```

---

## 命令行模式

### 基本用法

```bash
python WinPE_Customizer.py [工作目录]
```

### 配置文件控制

所有配置通过 `config.py` 控制：

```python
# 路径配置
WINPE_DIR = "D:/WinPE_amd64"
CAB_PATH = "C:/Program Files (x86)/Windows Kits/10/.../WinPE_OCs"
DRIVER_DIR = "drive"

# 模块开关
ENABLE_FEATURE_PACKS = True
ENABLE_LANGUAGE_PACKS = True
ENABLE_DRIVERS = True
ENABLE_MAKE_ISO = True
```

### 脚本集成示例

```python
#!/usr/bin/env python3
from WinPE_Customizer import WinPECustomizer
import config

# 自定义配置
config.WINPE_DIR = "D:/MyWinPE"
config.ENABLE_EXTERNAL_APPS = False
config.ENABLE_MAKE_ISO = True

# 创建定制器
customizer = WinPECustomizer("D:/MyWinPE")

# 执行定制
exit_code = customizer.run()

print(f"完成，退出代码: {exit_code}")
```

### 批处理脚本

```batch
@echo off
echo 开始创建 WinPE...

REM 设置环境
call "C:\Program Files (x86)\Windows Kits\10\...\DandISetEnv.bat"

REM 运行定制器
python WinPE_Customizer.py D:\WinPE_amd64

if %ERRORLEVEL% EQU 0 (
    echo 成功！
) else (
    echo 失败，退出代码: %ERRORLEVEL%
)

pause
```

---

## 故障排查

### 常见错误

**错误: "找不到 Windows ADK"**
```
解决:
1. 确认已安装 Windows ADK
2. 检查 config.py 中的 CAB_PATH
3. 确保路径指向 WinPE_OCs 目录
```

**错误: "WIM 需要重新挂载"**
```
解决:
1. 点击"清理 WIM"按钮
2. 或运行 cleanup.bat
3. 或手动: dism /cleanup-wim
```

**错误: "权限不足"**
```
解决:
必须在"部署和映像工具环境"中以管理员身份运行
```

**错误: "驱动安装失败"**
```
检查:
1. 驱动架构是否匹配（x64/x86）
2. 驱动是否包含有效的 .inf 文件
3. 查看详细日志了解具体错误
```

### 日志分析

日志位置：
- 程序日志: 界面中的"运行日志"区域
- DISM 日志: `C:\WINDOWS\Logs\DISM\dism.log`

查看 DISM 日志：
```bash
notepad C:\WINDOWS\Logs\DISM\dism.log
```

### 清理和重置

**清理临时文件**
```
主控制面板 → 🧹 清理临时文件
```

**清理 WIM 挂载点**
```
主控制面板 → 🔧 清理 WIM
```

**完全重置**
```bash
# 删除整个 WinPE 工作目录
rmdir /s /q D:\WinPE_amd64

# 重新开始
一键执行全流程
```

---

## 性能优化

### 加速建议

1. **使用 SSD**: 将工作目录放在 SSD 上
2. **关闭杀毒软件**: 暂时禁用实时保护
3. **减少模块**: 只启用必需的功能包
4. **预提取驱动**: 提前整理好驱动目录

### 磁盘空间管理

估算空间需求：
- 基础 WinPE: ~500MB
- 添加功能包: +200-500MB
- 添加驱动: +500MB-2GB
- 最终 ISO: ~800MB-3GB

清理空间：
```bash
# 删除临时文件
cleanup.bat

# 删除旧的 WinPE 目录
rmdir /s /q D:\WinPE_amd64_old
```

---

## 技术支持

### 文档资源

- [快速参考手册](快速参考手册.md) - 速查表
- [配置说明](config配置说明.md) - 参数详解
- [常见问题](常见问题.md) - FAQ

### 外部资源

- Microsoft Docs: https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/winpe-intro
- Windows ADK: https://learn.microsoft.com/zh-cn/windows-hardware/get-started/adk-install
- DISM 参考: https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/dism---deployment-image-servicing-and-management-technical-reference-for-windows

### 获取帮助

1. 查看界面内置帮助（帮助标签页）
2. 阅读 docs 目录中的文档
3. 查看程序日志和 DISM 日志
4. 访问 Microsoft Docs 获取官方文档

---

**祝使用愉快！**

