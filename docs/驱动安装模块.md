# 驱动安装模块详细说明

## 📋 模块概述

驱动安装模块负责将硬件驱动程序批量集成到 WinPE 映像中，使 WinPE 能够识别和支持各种硬件设备。

**配置开关：** `ENABLE_DRIVERS = True`

---

## 🎯 主要功能

### 1. 批量驱动安装
- 递归扫描驱动目录
- 自动识别驱动文件（.inf）
- 按子目录分步安装
- 实时显示安装进度

### 2. 驱动兼容性检测
- 自动匹配系统架构（x64/x86）
- 检查驱动签名
- 过滤不兼容的驱动

### 3. 进度显示
- 显示当前子目录名称
- 显示安装百分比
- 统计已安装驱动数量

---

## 📁 目录结构

### 推荐的驱动目录组织

```
drive/
├── Network/                  # 网卡驱动
│   ├── Intel/               # Intel 网卡
│   ├── Realtek/             # 瑞昱网卡
│   └── Broadcom/            # 博通网卡
│
├── Storage/                  # 存储控制器驱动
│   ├── AHCI/                # AHCI 控制器
│   ├── RAID/                # RAID 控制器
│   └── NVMe/                # NVMe 驱动
│
├── USB/                      # USB 驱动
│   ├── USB3.0/              # USB 3.0 驱动
│   └── USB-C/               # USB Type-C 驱动
│
├── Chipset/                  # 芯片组驱动
│   ├── Intel/               # Intel 芯片组
│   └── AMD/                 # AMD 芯片组
│
└── Other/                    # 其他驱动
    ├── Bluetooth/           # 蓝牙驱动
    ├── WiFi/                # 无线网卡
    └── Video/               # 显卡驱动（可选）
```

### 目录组织原则

1. **按设备类型分类**：便于管理和维护
2. **按厂商分组**：相同厂商的驱动放一起
3. **一个子目录一个驱动包**：避免冲突

---

## 🔧 使用方法

### 方法一：手动准备驱动

1. **下载驱动包**
   - 从硬件厂商官网下载
   - 选择 Windows 10/11 x64 版本
   - 下载独立驱动包（不要驱动安装程序）

2. **解压驱动**
   ```
   驱动通常包含：
   ├── *.inf        # 驱动信息文件（必需）
   ├── *.sys        # 驱动程序文件（必需）
   ├── *.cat        # 驱动签名文件（推荐）
   └── *.dll        # 相关库文件（可选）
   ```

3. **放置驱动**
   - 复制到 `drive/` 对应子目录
   - 保持驱动包的原始结构

4. **运行程序**
   - 启用驱动安装模块
   - 自动递归安装所有驱动

### 方法二：使用 SDIO 驱动提取工具

1. **启动驱动提取工具**
   ```bash
   tools/extract_sdio_drivers_gui.py
   ```

2. **选择驱动源**
   - 从系统驱动存储提取
   - 从驱动安装包提取

3. **自动分类**
   - 工具自动按设备类型分类
   - 生成标准目录结构

---

## 📝 配置说明

### 基本配置

在 `config.py` 中配置：

```python
# 驱动程序目录（相对于脚本目录）
DRIVER_DIR = "drive"

# 是否批量安装驱动程序
ENABLE_DRIVERS = True
```

### 高级配置

```python
# DISM 命令超时时间（秒）
DISM_TIMEOUT = 600  # 驱动多时可增加

# 是否显示详细的 DISM 输出
VERBOSE_DISM_OUTPUT = False

# 是否在出错时自动重试
AUTO_RETRY_ON_ERROR = False
```

---

## 🚀 安装过程

### 执行流程

1. **扫描驱动目录**
   ```
   [扫描] 开始扫描驱动目录: D:\WinPE_work\drive
   [扫描] 发现 5 个驱动子目录
   ```

2. **逐个安装驱动**
   ```
   [1/5] 正在处理: Network
   进度: 0%
   进度: 50%
   进度: 100%
   已安装 15 个驱动
   
   [2/5] 正在处理: Storage
   进度: 0%
   ...
   ```

3. **完成统计**
   ```
   [完成] 驱动安装完成
   总计安装 45 个驱动
   ```

### 安装日志

日志示例：
```
[22:30:15] [开始] 步骤 7: 批量安装驱动程序
[22:30:15] [扫描] 驱动目录: D:\WinPE_work\drive
[22:30:15] [扫描] 发现 3 个驱动子目录
[22:30:16] [1/3] 处理子目录: Network
[22:30:16]   执行命令: dism /image:"D:\WinPE_amd64\mount" /add-driver /driver:"D:\WinPE_work\drive\Network" /recurse
[22:30:20]   已安装 5 个驱动
[22:30:20]   进度: 33%
[22:30:21] [2/3] 处理子目录: Storage
...
[22:31:45] [完成] 共安装 23 个驱动
```

---

## 🛠️ 驱动来源推荐

### 网卡驱动

| 厂商 | 下载地址 | 说明 |
|------|---------|------|
| Intel | https://www.intel.com/content/www/us/en/download-center/home.html | 主流网卡驱动 |
| Realtek | https://www.realtek.com/en/downloads | 常用有线/无线网卡 |
| Broadcom | https://www.broadcom.com/support/download-search | 企业级网卡 |

### 存储驱动

| 类型 | 来源 | 说明 |
|------|------|------|
| NVMe | 主板厂商官网 | NVMe 固态硬盘驱动 |
| RAID | 主板或服务器厂商 | RAID 控制器驱动 |
| AHCI | Windows 自带 | 一般无需额外安装 |

### USB 驱动

| 类型 | 来源 | 说明 |
|------|------|------|
| USB 3.0 | Intel/AMD 芯片组驱动 | 包含在芯片组驱动中 |
| USB-C | 主板厂商 | 部分需要专用驱动 |

### 芯片组驱动

| 厂商 | 下载地址 |
|------|---------|
| Intel | https://www.intel.com/content/www/us/en/download/19347/chipset-inf-utility.html |
| AMD | https://www.amd.com/en/support/chipsets |

---

## ⚠️ 注意事项

### 1. 架构匹配
- WinPE x64 只能使用 64 位驱动
- WinPE x86 只能使用 32 位驱动
- 混用会导致安装失败

### 2. 驱动签名
- 建议使用微软签名的驱动
- 未签名驱动可能无法加载
- 测试驱动需禁用签名验证

### 3. 驱动冲突
- 同类设备避免安装多个驱动
- 通用驱动和专用驱动选一个
- 冲突时 WinPE 可能无法启动

### 4. 驱动体积
- 驱动会增大 WinPE 体积
- 建议只安装必需驱动
- 显卡驱动通常很大，可不安装

### 5. 兼容性
- 优先使用 Windows 10/11 版本驱动
- Windows 7 驱动可能不兼容
- 服务器驱动注意系统版本

---

## 🔍 故障排除

### 问题1：驱动安装失败

**现象：**
```
错误: 找不到驱动程序
```

**解决方法：**
1. 检查 `.inf` 文件是否存在
2. 确认驱动架构匹配（x64/x86）
3. 查看 DISM 详细日志

### 问题2：部分驱动未安装

**现象：**
```
警告: 跳过 3 个不兼容的驱动
```

**解决方法：**
1. 检查驱动版本是否支持 Windows 10
2. 确认驱动文件完整
3. 查看是否缺少依赖文件

### 问题3：安装过程卡住

**现象：**
```
进度: 45% (长时间无响应)
```

**解决方法：**
1. 等待（某些驱动安装较慢）
2. 增加 `DISM_TIMEOUT` 值
3. 检查驱动包是否损坏

### 问题4：WinPE 启动后设备不工作

**现象：**
- 驱动安装成功，但设备无法使用

**解决方法：**
1. 确认驱动确实安装到 WinPE
2. 检查设备是否需要特定服务
3. 查看设备管理器中的设备状态

---

## 📊 性能优化

### 优化建议

1. **按类型分目录**
   - 减少单次安装驱动数量
   - 提高安装成功率

2. **删除不必要文件**
   - 只保留 `.inf`、`.sys`、`.cat`
   - 删除说明文档、示例代码

3. **合并同类驱动**
   - 同厂商网卡驱动可合并
   - 减少子目录数量

4. **预筛选驱动**
   - 只保留目标平台驱动
   - 移除测试版、开发版驱动

---

## 📈 统计信息

### 常见驱动大小

| 驱动类型 | 典型大小 | 备注 |
|---------|---------|------|
| 网卡驱动 | 5-20 MB | 单个设备 |
| 存储驱动 | 1-10 MB | 控制器驱动 |
| USB驱动 | 5-15 MB | 包含在芯片组中 |
| 芯片组驱动 | 10-50 MB | 包含多个组件 |
| 显卡驱动 | 300-600 MB | **不推荐安装** |

### WinPE 体积影响

```
基础 WinPE: ~300 MB
+ 网卡驱动: +20 MB
+ 存储驱动: +10 MB
+ 芯片组驱动: +30 MB
= 总计: ~360 MB
```

---

## 🔗 相关工具

### 驱动管理工具

1. **SDIO (Snappy Driver Installer Origin)**
   - 自动检测并下载驱动
   - 支持离线驱动包
   - 下载：https://www.snappy-driver-installer.org/

2. **DriverStore Explorer**
   - 管理驱动存储
   - 清理旧驱动
   - 下载：https://github.com/lostindark/DriverStoreExplorer

3. **DISM GUI**
   - 图形化 DISM 工具
   - 手动添加驱动
   - 下载：见 WinPE 工具管理器

---

## 📚 扩展阅读

- [DISM 驱动管理命令](https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/dism-driver-servicing-command-line-options)
- [Windows 驱动签名要求](https://docs.microsoft.com/en-us/windows-hardware/drivers/install/driver-signing)
- [WinPE 驱动限制](https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/winpe-add-drivers)

---

**最后更新：** 2025-10-20
**版本：** v3.0

