# 外置程序模块详细说明

## 📋 模块概述

外置程序模块负责将第三方工具和应用程序集成到 WinPE 映像中，使 WinPE 具备更强大的功能。

**配置开关：** `ENABLE_EXTERNAL_APPS = True`

---

## 🎯 主要功能

### 1. 程序集成
- 复制程序文件到 WinPE
- 保持程序目录结构
- 支持单文件和多文件程序

### 2. 快捷方式管理
- 自动创建桌面快捷方式
- 添加到开始菜单
- 配置程序图标

### 3. 环境配置
- 添加程序到 PATH
- 配置注册表项
- 设置文件关联

---

## 📁 目录结构

### 标准目录组织

```
外置程序/
├── Tools/                    # 工具类程序
│   ├── Dism++/              # Dism++ 工具
│   │   ├── Dism++x64.exe
│   │   ├── Config/
│   │   └── Plugins/
│   │
│   ├── DiskGenius/          # DiskGenius 分区工具
│   │   ├── DiskGenius.exe
│   │   └── *.dll
│   │
│   ├── 7-Zip/               # 7-Zip 压缩工具
│   │   ├── 7zFM.exe
│   │   ├── 7zG.exe
│   │   ├── 7z.dll
│   │   └── Lang/
│   │
│   ├── Notepad++/           # Notepad++ 编辑器
│   │   ├── notepad++.exe
│   │   ├── plugins/
│   │   └── themes/
│   │
│   └── [其他工具]/
│
├── System/                   # 系统工具
│   ├── PowerShell/
│   └── Python/
│
└── Custom/                   # 自定义程序
    └── [自定义工具]/
```

### 文件放置规则

1. **独立目录**：每个程序单独一个文件夹
2. **完整文件**：包含所有依赖文件
3. **相对路径**：保持程序内部的相对路径

---

## 🔧 使用方法

### 方法一：手动配置

1. **编辑配置文件** (`config.py`)

```python
EXTERNAL_APPS = [
    # 格式：(源路径, 目标路径, 描述, 选项列表)
    
    # 添加到桌面
    ("Tools/Dism++/Dism++x64.exe", "Windows/System32", "Dism++", ["desktop"]),
    
    # 添加到桌面和开始菜单
    ("Tools/DiskGenius/DiskGenius.exe", "Windows/System32", "DiskGenius", 
     ["desktop", "startmenu"]),
    
    # 添加到 PATH
    ("Tools/7-Zip/7zFM.exe", "Program Files/7-Zip", "7-Zip", ["desktop", "path"]),
    
    # 只复制，不创建快捷方式
    ("Tools/Notepad++/notepad++.exe", "Program Files/Notepad++", "Notepad++", []),
]
```

2. **放置程序文件**

```bash
# 复制程序到外置程序目录
xcopy /E /I "C:\Program Files\Dism++" "外置程序\Tools\Dism++"
```

3. **运行定制器**

```bash
# 启用外置程序模块
python core/WinPE_Customizer.py
```

### 方法二：使用工具管理器（推荐）

1. **启动工具管理器**
   - 在主界面点击 `WinPE Tools` 按钮
   - 或直接运行 `tools/winpe_tools_manager.py`

2. **选择工具**
   ```
   推荐工具标签页：
   ☑ Dism++         ☑ 添加到桌面
   ☑ DiskGenius     ☑ 添加到桌面
   ☑ 7-Zip          ☑ 添加到桌面  🖱️ 支持右键菜单
   ☑ Notepad++      ☐ 添加到桌面
   ```

3. **下载工具**
   - 点击 `访问官网` 链接
   - 下载工具程序
   - 解压到指定目录

4. **保存配置**
   - 切换到 `配置代码` 标签页
   - 点击 `💾 直接保存到config.py`
   - 确认保存

5. **自动集成**
   - 工具自动添加到配置
   - 包括桌面快捷方式选项
   - 7-Zip 自动配置右键菜单

---

## 📝 配置选项

### 基本配置

```python
# 附加程序目录（相对于脚本目录）
EXTERNAL_APPS_DIR = "外置程序"

# 是否复制附加程序
ENABLE_EXTERNAL_APPS = True
```

### 程序配置格式

```python
EXTERNAL_APPS = [
    (
        "源文件路径",        # 相对于 EXTERNAL_APPS_DIR
        "目标路径",          # 相对于 WinPE 根目录
        "程序描述",          # 显示名称
        ["选项1", "选项2"]   # 放置选项
    ),
]
```

### 放置选项

| 选项 | 说明 | 效果 |
|------|------|------|
| `"desktop"` | 添加到桌面 | 在 WinPE 桌面创建快捷方式 |
| `"startmenu"` | 添加到开始菜单 | 在开始菜单创建项目 |
| `"path"` | 添加到 PATH | 可在任意位置直接运行 |
| `[]` | 只复制文件 | 不创建快捷方式 |

---

## 🛠️ 推荐工具列表

### 系统管理工具

| 工具 | 功能 | 推荐指数 | 官网 |
|------|------|----------|------|
| **Dism++** | 映像管理、系统优化 | ⭐⭐⭐⭐⭐ | https://github.com/Chuyu-Team/Dism-Multi-language |
| **DiskGenius** | 磁盘分区、数据恢复 | ⭐⭐⭐⭐⭐ | https://www.diskgenius.cn/ |
| **WinNTSetup** | Windows 系统安装 | ⭐⭐⭐⭐ | https://msfn.org/board/topic/149612-winntsetup/ |

### 压缩工具

| 工具 | 功能 | 推荐指数 | 官网 |
|------|------|----------|------|
| **7-Zip** | 压缩解压（支持右键菜单） | ⭐⭐⭐⭐⭐ | https://www.7-zip.org/ |

### 文本编辑

| 工具 | 功能 | 推荐指数 | 官网 |
|------|------|----------|------|
| **Notepad++** | 高级文本编辑器 | ⭐⭐⭐⭐ | https://notepad-plus-plus.org/ |
| **VSCode Portable** | 代码编辑器（便携版） | ⭐⭐⭐ | https://code.visualstudio.com/docs/editor/portable |

### 浏览器

| 工具 | 功能 | 推荐指数 | 官网 |
|------|------|----------|------|
| **GreenBrowser** | 轻量级浏览器 | ⭐⭐⭐⭐ | http://www.morequick.com/ |
| **Firefox Portable** | Firefox 便携版 | ⭐⭐⭐ | https://portableapps.com/apps/internet/firefox_portable |

### 硬件检测

| 工具 | 功能 | 推荐指数 | 官网 |
|------|------|----------|------|
| **CPU-Z** | CPU 信息检测 | ⭐⭐⭐⭐ | https://www.cpuid.com/softwares/cpu-z.html |
| **CrystalDiskInfo** | 硬盘健康监测 | ⭐⭐⭐⭐ | https://crystalmark.info/ |
| **HWiNFO** | 综合硬件信息 | ⭐⭐⭐⭐ | https://www.hwinfo.com/ |

### 网络工具

| 工具 | 功能 | 推荐指数 | 官网 |
|------|------|----------|------|
| **PuTTY** | SSH/Telnet 客户端 | ⭐⭐⭐ | https://www.putty.org/ |
| **WinSCP** | SFTP/FTP 客户端 | ⭐⭐⭐ | https://winscp.net/ |

### 数据恢复

| 工具 | 功能 | 推荐指数 | 官网 |
|------|------|----------|------|
| **Recuva** | 文件恢复 | ⭐⭐⭐⭐ | https://www.ccleaner.com/recuva |

### 文件管理

| 工具 | 功能 | 推荐指数 | 官网 |
|------|------|----------|------|
| **FastCopy** | 快速文件复制 | ⭐⭐⭐ | https://fastcopy.jp/ |
| **TreeSize Free** | 磁盘空间分析 | ⭐⭐⭐ | https://www.jam-software.com/treesize_free |

### 启动盘制作

| 工具 | 功能 | 推荐指数 | 官网 |
|------|------|----------|------|
| **Rufus** | USB启动盘制作 | ⭐⭐⭐⭐ | https://rufus.ie/ |

---

## 💡 使用技巧

### 1. 减小 WinPE 体积

**只安装必需工具：**
```python
# 最小化配置
EXTERNAL_APPS = [
    ("Tools/Dism++/Dism++x64.exe", "Windows/System32", "Dism++", ["desktop"]),
    ("Tools/DiskGenius/DiskGenius.exe", "Windows/System32", "DiskGenius", ["desktop"]),
]
```

**使用绿色版/便携版：**
- 避免使用需要安装的程序
- 选择 Portable 版本
- 删除不必要的语言文件

### 2. 优化启动速度

**减少桌面快捷方式：**
```python
# 只为常用工具创建快捷方式
("Tools/Dism++/Dism++x64.exe", "Windows/System32", "Dism++", ["desktop"]),
("Tools/其他工具/tool.exe", "Tools", "其他工具", []),  # 不创建快捷方式
```

**使用相对路径：**
- 程序内部使用相对路径
- 避免硬编码 C:\ 等盘符

### 3. 批量添加工具

**使用循环：**
```python
TOOLS_LIST = [
    "Dism++",
    "DiskGenius",
    "7-Zip",
    "Notepad++",
]

EXTERNAL_APPS = [
    (f"Tools/{tool}/{tool}.exe", "Windows/System32", tool, ["desktop"])
    for tool in TOOLS_LIST
]
```

### 4. 条件集成

**根据需求启用：**
```python
# 开发版包含更多工具
if DEBUG_MODE:
    EXTERNAL_APPS.extend([
        ("Tools/VSCode/Code.exe", "Program Files/VSCode", "VSCode", ["desktop"]),
        ("Tools/Python/python.exe", "Python", "Python", ["path"]),
    ])
```

---

## ⚠️ 注意事项

### 1. 程序兼容性

**检查项：**
- ✅ 支持 Windows 10/11
- ✅ 支持便携模式运行
- ✅ 不依赖注册表
- ✅ 不需要管理员权限（或已提权）
- ⚠️ 避免使用 .NET Framework 4.5+（WinPE 默认不包含）

**不推荐的程序类型：**
- 需要安装的程序
- 依赖特定服务的程序
- 需要驱动的程序
- 大型 IDE（如 Visual Studio）

### 2. 许可证问题

**注意事项：**
- ✅ 使用开源/免费软件
- ✅ 购买商业软件授权
- ❌ 不要集成盗版软件
- ⚠️ 注意分发限制

### 3. 文件路径

**路径规则：**
- 使用 `/` 而不是 `\`
- 相对路径相对于 `EXTERNAL_APPS_DIR`
- 目标路径相对于 WinPE 根目录（X:\）

**示例：**
```python
# ✅ 正确
("Tools/7-Zip/7zFM.exe", "Program Files/7-Zip", "7-Zip", ["desktop"])

# ❌ 错误
("Tools\\7-Zip\\7zFM.exe", "C:\\Program Files\\7-Zip", "7-Zip", ["desktop"])
```

### 4. 程序大小

**体积控制：**
```
推荐单个工具 < 100 MB
总外置程序 < 500 MB
WinPE 总体积 < 1 GB
```

**大文件处理：**
- 删除帮助文档
- 删除示例文件
- 删除不必要的语言包
- 压缩可执行文件（UPX）

### 5. 右键菜单

**7-Zip 特殊配置：**
- 勾选 7-Zip 后自动启用右键菜单
- 取消勾选后自动禁用右键菜单
- 确保 7-Zip 放在配置的路径中

---

## 🔍 故障排除

### 问题1：程序无法启动

**现象：**
```
双击程序图标无响应
```

**解决方法：**
1. 检查程序是否完整复制
2. 检查依赖文件（DLL）是否存在
3. 检查程序是否支持便携运行
4. 查看事件查看器中的错误

### 问题2：快捷方式无效

**现象：**
```
桌面快捷方式打不开
```

**解决方法：**
1. 检查目标路径是否正确
2. 检查程序文件是否存在
3. 重新生成 WinPE

### 问题3：程序提示缺少文件

**现象：**
```
错误: 无法找到 xxx.dll
```

**解决方法：**
1. 复制完整的程序目录
2. 包含所有依赖文件
3. 使用 Dependency Walker 检查依赖

### 问题4：WinPE 启动变慢

**现象：**
```
WinPE 启动时间明显增加
```

**解决方法：**
1. 减少桌面快捷方式数量
2. 删除不必要的程序
3. 使用 SSD 或 USB 3.0

---

## 📊 示例配置

### 配置1：最小化（维护用）

```python
EXTERNAL_APPS = [
    ("Tools/Dism++/Dism++x64.exe", "Windows/System32", "Dism++", ["desktop"]),
    ("Tools/DiskGenius/DiskGenius.exe", "Windows/System32", "DiskGenius", ["desktop"]),
    ("Tools/Notepad++/notepad++.exe", "Windows/System32", "Notepad++", []),
]
```

**体积：** ~350 MB  
**用途：** 系统维护、数据恢复

### 配置2：标准（通用）

```python
EXTERNAL_APPS = [
    # 系统工具
    ("Tools/Dism++/Dism++x64.exe", "Windows/System32", "Dism++", ["desktop"]),
    ("Tools/DiskGenius/DiskGenius.exe", "Windows/System32", "DiskGenius", ["desktop"]),
    ("Tools/WinNTSetup/WinNTSetup.exe", "Windows/System32", "WinNTSetup", ["desktop"]),
    
    # 压缩工具
    ("Tools/7-Zip/7zFM.exe", "Program Files/7-Zip", "7-Zip", ["desktop"]),
    
    # 文本编辑
    ("Tools/Notepad++/notepad++.exe", "Program Files/Notepad++", "Notepad++", []),
    
    # 浏览器
    ("Tools/GreenBrowser/GreenBrowser.exe", "Program Files/GreenBrowser", "GreenBrowser", ["desktop"]),
]
```

**体积：** ~500 MB  
**用途：** 系统安装、维护、日常使用

### 配置3：完整（专业）

```python
EXTERNAL_APPS = [
    # 系统管理
    ("Tools/Dism++/Dism++x64.exe", "Windows/System32", "Dism++", ["desktop"]),
    ("Tools/DiskGenius/DiskGenius.exe", "Windows/System32", "DiskGenius", ["desktop"]),
    ("Tools/WinNTSetup/WinNTSetup.exe", "Windows/System32", "WinNTSetup", ["desktop"]),
    
    # 压缩工具
    ("Tools/7-Zip/7zFM.exe", "Program Files/7-Zip", "7-Zip", ["desktop"]),
    
    # 文本编辑
    ("Tools/Notepad++/notepad++.exe", "Program Files/Notepad++", "Notepad++", []),
    ("Tools/VSCode/Code.exe", "Program Files/VSCode", "VSCode", ["desktop"]),
    
    # 浏览器
    ("Tools/GreenBrowser/GreenBrowser.exe", "Program Files/GreenBrowser", "GreenBrowser", ["desktop"]),
    
    # 硬件检测
    ("Tools/CPU-Z/cpuz.exe", "Tools", "CPU-Z", []),
    ("Tools/CrystalDiskInfo/DiskInfo64.exe", "Tools", "CrystalDiskInfo", []),
    ("Tools/HWiNFO/HWiNFO64.exe", "Tools", "HWiNFO", []),
    
    # 网络工具
    ("Tools/PuTTY/putty.exe", "Tools", "PuTTY", []),
    ("Tools/WinSCP/WinSCP.exe", "Tools", "WinSCP", []),
    
    # 数据恢复
    ("Tools/Recuva/Recuva64.exe", "Tools", "Recuva", []),
    
    # 文件管理
    ("Tools/FastCopy/FastCopy.exe", "Tools", "FastCopy", []),
    ("Tools/TreeSize/TreeSizeFree.exe", "Tools", "TreeSize", []),
]
```

**体积：** ~800 MB  
**用途：** 专业维护、开发、测试

---

## 📚 扩展阅读

- [WinPE 程序兼容性指南](https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/winpe-intro)
- [便携软件收集](https://portableapps.com/)
- [绿色软件联盟](https://www.portablesoft.org/)

---

**最后更新：** 2025-10-20
**版本：** v3.0

