# WinPE Customizer 模块说明

## 📋 模块总览

WinPE Customizer 提供了一系列模块化功能，每个模块独立工作，可以根据需要启用或禁用。

### 模块列表

| 模块名称 | 配置开关 | 功能描述 | 默认状态 |
|---------|---------|---------|---------|
| 创建WinPE环境 | `ENABLE_COPYPE_SETUP` | 自动创建 WinPE 工作目录 | ✅ 启用 |
| 自动挂载 | `ENABLE_AUTO_MOUNT` | 自动挂载 boot.wim 映像 | ✅ 启用 |
| 功能包安装 | `ENABLE_FEATURE_PACKS` | 安装 WinPE 功能组件 | ✅ 启用 |
| 语言包安装 | `ENABLE_LANGUAGE_PACKS` | 安装中文语言包 | ✅ 启用 |
| 字体支持 | `ENABLE_FONTS_LP` | 安装中文字体支持 | ✅ 启用 |
| 区域设置 | `ENABLE_REGIONAL_SETTINGS` | 配置时区、语言等 | ✅ 启用 |
| 驱动安装 | `ENABLE_DRIVERS` | 批量安装硬件驱动 | ✅ 启用 |
| 外置程序 | `ENABLE_EXTERNAL_APPS` | 复制第三方工具到 WinPE | ✅ 启用 |
| 自定义目录 | `ENABLE_CREATE_DIRS` | 创建工作目录结构 | ❌ 禁用 |
| 右键菜单 | `ENABLE_CONTEXT_MENU` | 配置7-Zip等右键菜单 | ✅ 启用 |
| ISO生成 | `ENABLE_MAKE_ISO` | 生成可启动ISO文件 | ✅ 启用 |

---

## 📦 模块详细说明

### 1. 创建WinPE环境模块

**配置项：** `ENABLE_COPYPE_SETUP = True`

**功能说明：**
- 自动运行 `copype.cmd` 创建 WinPE 工作环境
- 生成标准的 WinPE 目录结构（media、mount、fwfiles）
- 复制 Windows PE 启动文件

**使用场景：**
- 首次创建 WinPE 时必须启用
- 如果工作目录已存在，会自动跳过

**依赖：**
- 需要安装 Windows ADK
- 需要管理员权限

**相关配置：**
```python
WINPE_DIR = "D:/WinPE_amd64"  # WinPE 工作目录
```

---

### 2. 自动挂载模块

**配置项：** `ENABLE_AUTO_MOUNT = True`

**功能说明：**
- 自动挂载 `media/sources/boot.wim` 到 `mount` 目录
- 检测 WIM 是否已挂载，避免重复挂载
- 提供卸载清理功能

**使用场景：**
- 需要修改 WinPE 映像内容时
- 大部分定制操作都需要先挂载 WIM

**注意事项：**
- 确保之前没有未卸载的挂载点
- 异常中断后可能需要手动清理：`dism /cleanup-wim`

---

### 3. 功能包安装模块

**配置项：** `ENABLE_FEATURE_PACKS = True`

**功能说明：**
- 安装 WinPE 可选组件（Optional Components）
- 提供 PowerShell、WMI、.NET Framework 等功能
- 支持批量安装多个功能包

**默认安装的功能包：**
```python
FEATURE_PACKAGES = [
    ("WinPE-WMI", "WMI"),
    ("WinPE-NetFx", ".NET Framework"),
    ("WinPE-Scripting", "脚本宿主"),
    ("WinPE-PowerShell", "PowerShell"),
    ("WinPE-DismCmdlets", "DISM PowerShell"),
    ("WinPE-StorageWMI", "存储管理"),
    ("WinPE-SecureStartup", "BitLocker"),
    # ... 更多组件
]
```

**依赖关系：**
- 某些组件有依赖关系（如 PowerShell 依赖 WMI）
- 程序会自动按正确顺序安装

**自定义方法：**
- 编辑 `config.py` 中的 `FEATURE_PACKAGES` 列表
- 添加或删除组件

详细组件说明见：[WinPE功能包说明.md](./WinPE功能包说明.md)

---

### 4. 语言包安装模块

**配置项：** `ENABLE_LANGUAGE_PACKS = True`

**功能说明：**
- 安装功能包的中文语言包
- 使 WinPE 界面和工具显示中文

**安装的语言包：**
```python
LANGUAGE_PACKAGES = [
    ("WinPE-WMI_zh-cn", "WMI 中文"),
    ("WinPE-PowerShell_zh-cn", "PowerShell 中文"),
    ("WinPE-StorageWMI_zh-cn", "存储管理 中文"),
    # ... 对应功能包的语言包
]
```

**注意事项：**
- 必须先安装对应的功能包
- 语言包文件名格式：`功能包名_zh-cn`

---

### 5. 字体支持模块

**配置项：** `ENABLE_FONTS_LP = True`

**功能说明：**
- 安装中文字体支持包
- 安装核心语言包
- 确保 WinPE 能正确显示中文

**安装内容：**
```python
FONT_PACKAGES = [
    ("WinPE-FontSupport-ZH-CN", "中文字体支持包"),
    ("zh-cn/lp", "核心语言包"),
]
```

**效果：**
- WinPE 启动后界面显示中文
- 命令提示符支持中文显示

---

### 6. 区域设置模块

**配置项：** `ENABLE_REGIONAL_SETTINGS = True`

**功能说明：**
- 配置系统语言和区域
- 设置时区为中国标准时间
- 配置输入法

**配置内容：**
```python
REGIONAL_SETTINGS = [
    ("set-uilang:zh-cn", "界面语言"),
    ("set-syslocale:zh-cn", "系统区域"),
    ("set-userlocale:zh-cn", "用户区域"),
    ("set-inputlocale:0804:00000804", "输入法"),
    ('set-timezone:"China Standard Time"', "时区"),
    ("set-SKUIntlDefaults:zh-cn", "国际化默认值"),
]
```

**效果：**
- 时间显示正确（北京时间）
- 日期格式符合中国习惯
- 键盘布局为简体中文

---

### 7. 驱动安装模块

**配置项：** `ENABLE_DRIVERS = True`

**功能说明：**
- 批量安装硬件驱动到 WinPE
- 支持递归扫描驱动目录
- 自动检测并安装兼容驱动

**使用方法：**
1. 将驱动文件放到 `drive` 目录
2. 按厂商或设备类型分类：
   ```
   drive/
   ├── Network/        # 网卡驱动
   ├── Storage/        # 存储控制器
   ├── USB/            # USB 驱动
   └── Other/          # 其他驱动
   ```
3. 运行程序自动安装

**支持的驱动格式：**
- `.inf` 驱动安装文件
- `.sys` 驱动程序文件
- `.cat` 驱动签名文件

**注意事项：**
- 驱动必须是 64 位版本（对于 x64 WinPE）
- 建议使用微软签名的驱动
- 未签名驱动可能需要禁用签名验证

**进度显示：**
- 按子目录分步安装
- 显示每个子目录的安装进度
- 统计已安装驱动数量

详细说明见：[驱动安装模块.md](./驱动安装模块.md)

---

### 8. 外置程序模块

**配置项：** `ENABLE_EXTERNAL_APPS = True`

**功能说明：**
- 复制第三方工具到 WinPE
- 支持桌面快捷方式
- 支持自动添加到 PATH

**配置方法：**
```python
EXTERNAL_APPS = [
    # 格式：(源文件路径, 目标路径, 描述, 选项)
    ("Dism++/Dism++x64.exe", "Windows/System32", "Dism++", ["desktop"]),
    ("7-Zip/7zFM.exe", "Program Files/7-Zip", "7-Zip", ["desktop"]),
]
```

**选项说明：**
- `"desktop"`: 在 WinPE 桌面创建快捷方式
- `"startmenu"`: 添加到开始菜单
- `"path"`: 添加到系统 PATH

**推荐工具：**
- Dism++ - 系统映像管理
- DiskGenius - 磁盘分区
- 7-Zip - 压缩解压
- Notepad++ - 文本编辑
- 更多工具见 WinPE 工具管理器

**工具管理器：**
- 使用 `WinPE Tools` 按钮打开
- 图形化选择要集成的工具
- 自动生成配置代码

详细说明见：[外置程序模块.md](./外置程序模块.md)

---

### 9. 自定义目录模块

**配置项：** `ENABLE_CREATE_DIRS = False` （默认禁用）

**功能说明：**
- 在 WinPE 中创建自定义目录
- 用于存放临时文件、备份等

**配置方法：**
```python
CUSTOM_DIRECTORIES = [
    "Tools",          # 工具目录
    "Temp/Logs",      # 日志目录
    "Data/Backup",    # 备份目录
]
```

**使用场景：**
- 需要固定的工作目录
- 批处理脚本需要特定路径
- 组织化管理文件

**注意事项：**
- WinPE 重启后内容会丢失（RAM磁盘）
- 适合创建临时工作目录

---

### 10. 右键菜单模块

**配置项：** `ENABLE_CONTEXT_MENU = True`

**功能说明：**
- 为工具（如 7-Zip）配置右键菜单
- WinPE 启动时自动注册
- 支持文件和文件夹右键菜单

**支持的工具：**
- **7-Zip**：解压、压缩等操作

**7-Zip 右键菜单项：**
- 打开压缩包
- 解压到当前文件夹
- 解压到 {文件名}\
- 压缩文件
- 添加到压缩包

**配置方法：**
```python
SEVENZIP_CONTEXT_MENU = {
    "enabled": True,  # 是否启用
    "install_path": "X:\\Program Files\\7-Zip",
    "menu_items": [
        # 自定义菜单项...
    ]
}
```

**工作原理：**
1. 生成注册表文件（.reg）
2. 复制到 WinPE 映像
3. 修改 `startnet.cmd` 启动脚本
4. WinPE 启动时自动导入注册表

**注意事项：**
- 只有在工具管理器中勾选了 7-Zip 时才会启用
- 7-Zip 必须放在配置的路径中
- 支持扩展到其他工具

详细说明见：[右键菜单模块.md](./右键菜单模块.md)

---

### 11. ISO生成模块

**配置项：** `ENABLE_MAKE_ISO = True`

**功能说明：**
- 卸载 WIM 映像并提交更改
- 生成可启动的 ISO 文件
- 使用 `oscdimg` 工具创建

**生成过程：**
1. 卸载 `boot.wim` 并保存更改
2. 调用 `makewinpemedia` 生成 ISO
3. 保存到工作目录

**输出文件：**
```python
OUTPUT_ISO_NAME = "MyCustomWinPE.iso"
```

**ISO 特性：**
- UEFI 启动支持
- Legacy BIOS 启动支持
- El Torito 可启动格式

**后续操作：**
- 刻录到 U 盘：使用 USB 制作工具
- 刻录到光盘：使用光盘刻录软件
- 虚拟机测试：挂载 ISO 启动

---

## 🎯 模块组合推荐

### 最小化配置
适合快速测试或体积要求严格的场景：
```python
ENABLE_FEATURE_PACKS = False
ENABLE_LANGUAGE_PACKS = False
ENABLE_DRIVERS = False
ENABLE_EXTERNAL_APPS = False
```

### 标准配置（推荐）
平衡功能和体积：
```python
ENABLE_FEATURE_PACKS = True
ENABLE_LANGUAGE_PACKS = True
ENABLE_DRIVERS = True
ENABLE_EXTERNAL_APPS = True
```

### 完整配置
包含所有功能：
```python
所有模块 = True
```

---

## 🔧 模块开发指南

### 添加新模块

1. 在 `config.py` 添加开关：
```python
ENABLE_NEW_MODULE = True
```

2. 在 `WinPE_Customizer.py` 添加方法：
```python
def new_module_function(self):
    """新模块功能"""
    if not self.enable_new_module:
        return True
    
    self.print_header("步骤 X: 新模块")
    # 实现功能...
    return True
```

3. 在 `run()` 方法中调用：
```python
if self.enable_new_module:
    self.new_module_function()
```

### 模块最佳实践

1. **独立性**：模块间尽量减少依赖
2. **可配置**：提供详细的配置选项
3. **错误处理**：捕获异常，返回状态
4. **日志输出**：详细记录执行过程
5. **进度反馈**：显示进度和完成度

---

## 📚 相关文档

- [详细使用说明](./详细使用说明.md)
- [WinPE功能包说明](./WinPE功能包说明.md)
- [驱动安装模块](./驱动安装模块.md)
- [外置程序模块](./外置程序模块.md)
- [右键菜单模块](./右键菜单模块.md)

---

## ❓ 常见问题

### Q: 如何禁用某个模块？
A: 在 `config.py` 中将对应的 `ENABLE_XXX` 设置为 `False`

### Q: 模块执行顺序能改变吗？
A: 可以，编辑 `WinPE_Customizer.py` 的 `run()` 方法调整顺序。但注意依赖关系。

### Q: 模块失败会影响后续模块吗？
A: 不会。每个模块独立执行，失败后会继续执行下一个。

### Q: 如何查看模块执行日志？
A: 日志保存在 `WinPE_Customizer.log` 文件中。

---

**最后更新：** 2025-10-20
**版本：** v3.0

